name: Release Package CI

on:
  push:
    tags: ["v*"]
  workflow_dispatch:
    inputs:
      tag:
        description: "Release tag (e.g. v1.2.3)"
        required: true

jobs:
  build:
    name: Build wheels on ${{ matrix.os }}
    runs-on: ${{ matrix.os }}
    strategy:
      fail-fast: false
      matrix:
        os: [ubuntu-latest, ubuntu-24.04-arm, windows-latest, windows-11-arm]

    steps:
      - name: Checkout code
        uses: actions/checkout@v5
        with:          
          fetch-depth: 0
          fetch-tags: true

      - name: Set up Docker Buildx (Linux)
        if: startsWith(matrix.os, 'ubuntu')
        uses: docker/setup-buildx-action@v3

      - name: Build wujihandcpp (Linux)
        if: startsWith(matrix.os, 'ubuntu')
        uses: docker/build-push-action@v6
        with:
          context: .
          file: Dockerfile.package-builder
          outputs: type=local,dest=build/wujihandcpp/
          cache-from: type=gha,scope=wujihandcpp-build-${{ matrix.os }}
          cache-to: type=gha,mode=max,scope=wujihandcpp-build-${{ matrix.os }}

      - uses: actions/upload-artifact@v4      
        if: startsWith(matrix.os, 'ubuntu')
        with:
          name: build-wujihandcpp-${{ matrix.os }}
          path: |
            build/wujihandcpp/*.deb
            build/wujihandcpp/*.rpm
            build/wujihandcpp/*.zip

      - name: Install dependencies with vcpkg (Windows)
        if: startsWith(matrix.os, 'windows')
        run: |
          if ("${{ matrix.os }}" -eq "windows-latest") {
            $VCPKG_TRIPLET = "x64-windows"
          } elseif ("${{ matrix.os }}" -eq "windows-11-arm") {
            $VCPKG_TRIPLET = "arm64-windows"
          }
          echo "VCPKG_TRIPLET=$VCPKG_TRIPLET" | Out-File -FilePath $env:GITHUB_ENV -Encoding utf8 -Append
          vcpkg install libusb:$VCPKG_TRIPLET

      - name: Setup Python
        uses: actions/setup-python@v6
        with:
          python-version: "3.13"

      - name: Install cibuildwheel
        run: python -m pip install cibuildwheel

      - name: Build wujihandpy (Linux)
        if: startsWith(matrix.os, 'ubuntu')
        run: python -m cibuildwheel --output-dir build/wujihandpy

      - name: Build wujihandpy (Windows)
        if: startsWith(matrix.os, 'windows')
        run: |
          $VCPKG_ROOT = $env:VCPKG_INSTALLATION_ROOT -replace '\\','/'
          $env:CIBW_ENVIRONMENT_WINDOWS = "VCPKG_ROOT=$VCPKG_ROOT VCPKG_TRIPLET=$env:VCPKG_TRIPLET"
          python -m cibuildwheel --output-dir build/wujihandpy

      - uses: actions/upload-artifact@v4
        with:
          name: build-wujihandpy-${{ matrix.os }}
          path: build/wujihandpy/*.whl

  publish:
    name: Publish to PyPI
    needs: build
    runs-on: ubuntu-latest
    environment:
      name: pypi
      url: https://pypi.org/p/wujihandpy
    permissions:
      id-token: write
      contents: write

    steps:
      - name: Checkout code
        uses: actions/checkout@v5
        with:
          fetch-depth: 0
          fetch-tags: true

      - name: Parse CHANGELOG and Generate Release Body
        id: changelog
        uses: actions/github-script@v7
        with:
          script: |
            const fs = require('fs');

            if (!fs.existsSync('CHANGELOG.md')) {
              core.setFailed('CHANGELOG.md not found');
              return;
            }
            const changelog = fs.readFileSync('CHANGELOG.md', 'utf8')
              .replace(/\r\n?/g, '\n');

            // 支持 tag push 和 workflow_dispatch 两种触发方式
            const ref = context.ref;
            const dispatchTag = '${{ github.event.inputs.tag }}';
            const tag = ref.startsWith('refs/tags/')
              ? ref.replace('refs/tags/', '')
              : dispatchTag;
            if (!tag) {
              core.setFailed('No tag provided. For workflow_dispatch, please supply input "tag" (e.g. v1.2.3).');
              return;
            }
            const version = tag.replace(/^v/, '');

            // 分类映射
            const categoryMap = {
              'Added': 'New Features', '新增': 'New Features',
              'Changed': 'Improvements', '变更': 'Improvements',
              'Fixed': 'Bug Fixes', '修复': 'Bug Fixes'
            };
            const cautionCategories = {
              'Removed': 'Removed', '移除': 'Removed',
              'Deprecated': 'Deprecated', '废弃': 'Deprecated',
              'Security': 'Security', '安全': 'Security'
            };

            function parseContent(content) {
              const sections = { 'New Features': [], 'Improvements': [], 'Bug Fixes': [] };
              const cautionItems = [];
              let currentCategory = '';
              let currentCautionPrefix = '';

              for (const line of content.trim().split('\n')) {
                const catMatch = line.match(/^### (.+)/);
                if (catMatch) {
                  const cat = catMatch[1].trim();
                  if (categoryMap[cat]) {
                    currentCategory = categoryMap[cat];
                    currentCautionPrefix = '';
                  } else if (cautionCategories[cat]) {
                    currentCategory = 'CAUTION';
                    currentCautionPrefix = cautionCategories[cat];
                  } else {
                    currentCategory = '';
                  }
                } else if (line.startsWith('- ')) {
                  const item = line.slice(2);
                  if (currentCategory === 'CAUTION') {
                    cautionItems.push(`**${currentCautionPrefix}**: ${item}`);
                  } else if (currentCategory && sections[currentCategory]) {
                    sections[currentCategory].push(item);
                  }
                }
              }

              let body = '';
              for (const section of ['New Features', 'Improvements', 'Bug Fixes']) {
                if (sections[section].length > 0) {
                  body += `### ${section}\n${sections[section].map(i => `- ${i}`).join('\n')}\n\n`;
                }
              }
              if (cautionItems.length > 0) {
                body += `> [!CAUTION]\n${cautionItems.map(i => `> - ${i}`).join('\n')}\n\n`;
              }
              return body.trim();
            }

            const escapedVersion = version.replace(/[.*+?^${}()|[\]\\]/g, '\\$&');
            const versionRegex = new RegExp(`## \\[${escapedVersion}\\](?:[^\\n]*-\\s*(\\d{4}-\\d{2}-\\d{2}))?[^\\n]*\\n([\\s\\S]*?)(?=\\n## \\[|$)`);
            const match = changelog.match(versionRegex);

            if (!match) {
              core.setFailed(`Version ${version} not found in CHANGELOG.md`);
              return;
            }

            const date = match[1] || new Date().toISOString().split('T')[0];
            const content = match[2];
            let body = parseContent(content);

            const allVersions = [...changelog.matchAll(/## \[(\d+\.\d+\.\d+(?:-[a-zA-Z0-9.]+)?)\]/g)].map(m => m[1]);
            const versionIndex = allVersions.indexOf(version);
            if (versionIndex !== -1) {
              const prevVersion = allVersions[versionIndex + 1];
              if (prevVersion) {
                body += `\n\n---\n\n**Full Changelog**: [v${prevVersion}...${tag}](https://github.com/${context.repo.owner}/${context.repo.repo}/compare/v${prevVersion}...${tag})`;
              }
            }

            const releaseBody = `## ${tag} (${date})\n\n${body}`;
            const isPrerelease = /-/.test(version);
            core.setOutput('body', releaseBody);
            core.setOutput('tag', tag);
            core.setOutput('prerelease', isPrerelease.toString());

      - name: Download wujihandcpp builds
        uses: actions/download-artifact@v5
        with:
          path: build/wujihandcpp
          pattern: build-wujihandcpp-*
          merge-multiple: true

      - name: Download wujihandpy builds
        uses: actions/download-artifact@v5
        with:
          path: build/wujihandpy
          pattern: build-wujihandpy-*
          merge-multiple: true

      - name: Publish distribution to PyPI
        if: github.ref_type == 'tag'
        uses: pypa/gh-action-pypi-publish@release/v1
        with:
          packages-dir: build/wujihandpy

      - name: Create Release
        id: create_release
        uses: softprops/action-gh-release@v2
        with:
          tag_name: ${{ steps.changelog.outputs.tag }}
          name: ${{ steps.changelog.outputs.tag }}
          body: ${{ steps.changelog.outputs.body }}
          draft: false
          prerelease: ${{ steps.changelog.outputs.prerelease == 'true' }}
          make_latest: ${{ steps.changelog.outputs.prerelease == 'true' && 'false' || 'true' }}
          files: build/wujihandcpp/*
